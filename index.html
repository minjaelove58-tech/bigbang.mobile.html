<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Big Bang 3D â€” Mobile Ready</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
html,body{
  margin:0;
  height:100%;
  background:#000;
  color:#fff;
  font-family:system-ui,Segoe UI,Arial,sans-serif;
  overflow:hidden;
}
canvas{
  position:absolute;
  top:0;
  left:0;
  z-index:0;
  /* í„°ì¹˜ ë“œë˜ê·¸/í•€ì¹˜ ì œìŠ¤ì²˜ë¥¼ ìº”ë²„ìŠ¤ê°€ ì§ì ‘ ë°›ë„ë¡ */
  touch-action:none;
}

/* ---------- UI ê³µí†µ ---------- */
#hud,#panel,#playbox,#chartBox,#epochBadge,#epochLabels,#chartToggleBox{
  position:absolute;
  z-index:10;
}

/* ìƒë‹¨ ì •ë³´ ë°•ìŠ¤ */
#hud{
  top:12px;
  left:12px;
  background:rgba(0,0,30,.6);
  padding:10px 14px;
  border-radius:10px;
}
#hud .title{
  font-weight:700;
  color:#74e5ff;
  margin-bottom:6px;
}

/* ê·¸ë˜í”„ í† ê¸€ ë²„íŠ¼ ë°•ìŠ¤ (ìš°ìƒë‹¨, í”Œë ˆì´ ë²„íŠ¼ ì•„ë˜) */
#chartToggleBox{
  top:60px;
  right:15px;
  background:rgba(0,0,40,.6);
  padding:8px 12px;
  border-radius:8px;
}

/* Cosmic Time ìŠ¬ë¼ì´ë” íŒ¨ë„ (í•˜ë‹¨ ì¤‘ì•™) */
#panel{
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,25,.75);
  padding:10px 16px;
  border-radius:12px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  backdrop-filter:blur(8px);
  align-items:center;
}
.ctrl{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.ctrl label{
  font-size:13px;
  opacity:.85;
  text-align:center;
}

/* ---------- Cosmic Time ìŠ¬ë¼ì´ë” ---------- */
#time{
  width:280px;
  max-width:70vw;
  height:10px;
  border-radius:5px;
  outline:none;
  accent-color:#00e5ff;
  background:linear-gradient(to right,
    #ffffff 0%, #ffffff 5%, 
    #99ddff 5%, #66b9ff 25%, 
    #ffd580 25%, #ffd580 45%, 
    #aabbff 45%, #aabbff 100%);
}

/* ---------- Epoch ë¼ë²¨ ---------- */
#epochLabels{
  bottom:60px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  justify-content:space-between;
  width:520px;
  max-width:90vw;
  font-size:13px;
  color:#aaa;
}
#epochLabels span.active{
  color:#fff;
  font-weight:700;
  text-shadow:0 0 6px #00eaff;
}

/* ---------- Play ë²„íŠ¼ ---------- */
#playbox{
  top:15px;
  right:15px;
  background:rgba(0,0,40,.6);
  padding:8px 12px;
  border-radius:8px;
}
button{
  background:#008cff;
  color:#fff;
  border:0;
  border-radius:6px;
  padding:6px 14px;
  cursor:pointer;
  font-size:13px;
}
button:hover{
  background:#00aaff;
}

/* ---------- Chart Box (ì˜¤ë¥¸ìª½ ìœ„: PC) ---------- */
#chartBox{
  right:15px;
  top:80px;
  width:320px;
  height:180px;
  background:rgba(0,0,30,.6);
  padding:8px;
  border-radius:10px;
  backdrop-filter:blur(8px);
}

/* ---------- Epoch ë°°ì§€ ---------- */
#epochBadge{
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  padding:8px 12px;
  border-radius:10px;
  background:rgba(0,0,0,.25);
  font-weight:800;
  font-size:28px;
  pointer-events:none;
}

/* ---------- ëª¨ë°”ì¼/ì¢ì€ í™”ë©´ìš© ì¡°ì • ---------- */
@media (max-width: 900px){
  #hud{
    font-size:12px;
    padding:8px 10px;
  }
  #panel{
    bottom:10px;
    padding:8px 10px;
  }
  #epochLabels{
    bottom:70px;
    font-size:11px;
  }
  /* ê·¸ë˜í”„ë¥¼ ê°€ìš´ë° ì•„ë˜ìª½ìœ¼ë¡œ ë‚´ë ¤ì„œ UIì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ */
  #chartBox{
    left:50%;
    right:auto;
    transform:translateX(-50%);
    width:calc(100% - 30px);
    max-width:420px;
    height:150px;
    top:auto;
    bottom:120px;
  }
  #epochBadge{
    font-size:22px;
  }
}
</style>
</head>

<body>
<canvas id="bg"></canvas>

<div id="hud">
  <div class="title">ğŸŒŒ Big Bang 3D</div>
  <div id="epoch">Epoch: â€“</div>
  <div id="stats">a = â€“ | T = â€“ K | Ï = â€“</div>
</div>

<div id="playbox"><button id="playBtn">â–¶ Play</button></div>

<!-- ê·¸ë˜í”„ í† ê¸€ ë°•ìŠ¤ -->
<div id="chartToggleBox">
  <button id="chartToggleBtn">ğŸ“Š Hide Chart</button>
</div>

<div id="panel">
  <div class="ctrl">
    <label>â³ Cosmic Time (0â€“100)</label>
    <input id="time" type="range" min="0" max="100" value="0">
  </div>
</div>

<div id="epochLabels">
  <span id="labInflation">Inflation</span>
  <span id="labPlasma">Plasma</span>
  <span id="labRecomb">Recomb.</span>
  <span id="labDark">Dark A</span>
</div>

<div id="chartBox"><canvas id="chart"></canvas></div>
<div id="epochBadge">â€“</div>

<script>
/* ---------- ë¬¼ë¦¬ì‹ ---------- */
function a_phys(t,H0,Om,Ol){
  const H=(H0/100)*Math.sqrt(Om/Math.pow(1+t,3)+Ol);
  return Math.exp(H*t*1e-2);
}
function T_from_a(a){return 2.7/a;}
function rho_from_a(a){return 1/(a*a*a);}

/* t(0~1)ì— ë”°ë¼ Epochë¥¼ ê°•ì œë¡œ ìˆœì„œëŒ€ë¡œ ë°°ì¹˜ */
function epochOf_t(t){
  if (t < 0.15) return "Inflation";
  if (t < 0.45) return "Plasma Era";
  if (t < 0.70) return "Recombination";
  return "Dark Ages";
}

/* ---------- ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (ëˆˆ í¸í•œ í†¤) ---------- */
const STAR_CLR = {
  "Inflation": 0xffffff,     // í•˜ì–€ë³„
  "Plasma Era": 0xe0f4ff,    // ì•„ì£¼ ì—°í•œ í•˜ëŠ˜ìƒ‰
  "Recombination": 0xfff0c2, // ë”°ëœ»í•œ ì—°ë…¸ë‘
  "Dark Ages": 0xb7c2ff      // ì•½ê°„ ë³´ëë¹› íŒŒë‘
};
const BG_CLR = {
  "Inflation": "#000010",
  "Plasma Era": "#020024",
  "Recombination": "#150003",
  "Dark Ages": "#000010"
};

/* ---------- Three.js ---------- */
const canvas3d = document.getElementById("bg");
const renderer = new THREE.WebGLRenderer({antialias:true,canvas:canvas3d});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio||1,2));
renderer.setClearColor(0x000010);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,10000);

// ì¹´ë©”ë¼ êµ¬ë©´ì¢Œí‘œ
let radius=1200,theta=0,phi=0.9;
function updateCam(){
  camera.position.set(
    radius*Math.sin(phi)*Math.cos(theta),
    radius*Math.cos(phi),
    radius*Math.sin(phi)*Math.sin(theta)
  );
  camera.lookAt(0,0,0);
}
updateCam();

/* ---------- ë³„ ì  ìƒì„± ---------- */
const COUNT=40000;
const pos=new Float32Array(COUNT*3);
for(let i=0;i<COUNT;i++){
  const r=Math.pow(Math.random(),0.62)*260;
  const th=Math.random()*Math.PI*2;
  const ph=Math.acos(2*Math.random()-1);
  pos[i*3]   = r*Math.sin(ph)*Math.cos(th);
  pos[i*3+1] = r*Math.sin(ph)*Math.sin(th);
  pos[i*3+2] = r*Math.cos(ph);
}
const geo=new THREE.BufferGeometry();
geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
const mat=new THREE.PointsMaterial({
  color:0xffffff,
  size:3,
  sizeAttenuation:true
});
const stars=new THREE.Points(geo,mat);
scene.add(stars);

/* ---------- Chart.js ---------- */
const chart = new Chart(document.getElementById("chart"),{
 type:"line",
 data:{
  labels:[],
  datasets:[
    {label:"a(t)", borderColor:"#0ff", data:[], pointRadius:0, borderWidth:2},
    {label:"T(t)*1000K", borderColor:"#f93", data:[], pointRadius:0, borderWidth:2},
    {label:"Ï(t)", borderColor:"#9f3", data:[], pointRadius:0, borderWidth:2}
  ]
 },
 options:{
  animation:false,
  responsive:true,
  maintainAspectRatio:false,
  scales:{
    y:{type:"logarithmic",min:1e-6,max:1e6,ticks:{color:"#ccc"}},
    x:{ticks:{color:"#ccc"}}
  },
  plugins:{legend:{labels:{color:"#ccc"}}}
 }
});

/* ---------- UI ìš”ì†Œ ---------- */
const elTime = document.getElementById("time");
const epochEl = document.getElementById("epoch");
const statsEl = document.getElementById("stats");
const badge   = document.getElementById("epochBadge");
const playBtn = document.getElementById("playBtn");

const chartBox       = document.getElementById("chartBox");
const chartToggleBtn = document.getElementById("chartToggleBtn");
let chartVisible = true;

chartToggleBtn.onclick = () => {
  chartVisible = !chartVisible;
  chartBox.style.display = chartVisible ? "block" : "none";
  chartToggleBtn.textContent = chartVisible ? "ğŸ“Š Hide Chart" : "ğŸ“‰ Show Chart";
};

/* ---------- í¬ì¸í„° ê¸°ë°˜ ì¹´ë©”ë¼ ì œì–´ (ëª¨ë°”ì¼ + PC ê³µí†µ) ---------- */
const activePointers = new Map(); // id -> {x,y}
let rotateStartTheta = 0;
let rotateStartPhi   = 0;
let rotateStartPos   = {x:0,y:0};
let pinchStartDist   = null;
let pinchStartRadius = radius;

// í¬ì¸í„° ë‹¤ìš´
canvas3d.addEventListener("pointerdown", (e)=>{
  // ì™¼ìª½ ë²„íŠ¼/í„°ì¹˜ë§Œ
  if (e.button !== undefined && e.button !== 0) return;
  activePointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
  canvas3d.setPointerCapture(e.pointerId);

  if (activePointers.size === 1) {
    const p = activePointers.values().next().value;
    rotateStartPos = {x:p.x, y:p.y};
    rotateStartTheta = theta;
    rotateStartPhi   = phi;
    pinchStartDist = null;
  } else if (activePointers.size === 2) {
    const it = activePointers.values();
    const p1 = it.next().value;
    const p2 = it.next().value;
    const dx = p2.x - p1.x;
    const dy = p2.y - p1.y;
    pinchStartDist = Math.hypot(dx, dy) || 1;
    pinchStartRadius = radius;
  }
});

// í¬ì¸í„° ì´ë™
window.addEventListener("pointermove", (e)=>{
  if (!activePointers.has(e.pointerId)) return;
  activePointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

  if (activePointers.size === 1) {
    // 1ì†ê°€ë½/ë§ˆìš°ìŠ¤ â†’ íšŒì „
    const p = activePointers.values().next().value;
    const dx = p.x - rotateStartPos.x;
    const dy = p.y - rotateStartPos.y;
    theta = rotateStartTheta - dx * 0.005;
    phi   = rotateStartPhi   - dy * 0.005;
    // ìœ„/ì•„ë˜ ê·¹ì  ì œí•œ
    phi = Math.max(0.05, Math.min(Math.PI - 0.05, phi));
    updateCam();
  } else if (activePointers.size === 2) {
    // ë‘ ì†ê°€ë½ â†’ í•€ì¹˜ ì¤Œ
    const it = activePointers.values();
    const p1 = it.next().value;
    const p2 = it.next().value;
    const dx = p2.x - p1.x;
    const dy = p2.y - p1.y;
    const dist = Math.hypot(dx, dy) || 1;
    if (pinchStartDist != null) {
      const factor = pinchStartDist / dist;
      radius = pinchStartRadius * factor;
      radius = Math.max(200, Math.min(4000, radius));
      updateCam();
    } else {
      pinchStartDist = dist;
      pinchStartRadius = radius;
    }
  }
});

// í¬ì¸í„° ì—…/ì·¨ì†Œ
function endPointer(e){
  if (!activePointers.has(e.pointerId)) return;
  activePointers.delete(e.pointerId);
  try { canvas3d.releasePointerCapture(e.pointerId); } catch(_){}

  if (activePointers.size === 1) {
    // ë‘ ì†ê°€ë½ì—ì„œ í•˜ë‚˜ ë—„ ë•Œ â†’ ë‚¨ì€ ì†ê°€ë½ ê¸°ì¤€ìœ¼ë¡œ íšŒì „ ê¸°ì¤€ ì¬ì„¤ì •
    const p = activePointers.values().next().value;
    rotateStartPos = {x:p.x, y:p.y};
    rotateStartTheta = theta;
    rotateStartPhi   = phi;
    pinchStartDist = null;
  } else if (activePointers.size === 0) {
    pinchStartDist = null;
  }
}
window.addEventListener("pointerup", endPointer);
window.addEventListener("pointercancel", endPointer);

// ë§ˆìš°ìŠ¤ íœ  ì¤Œ (PC)
canvas3d.addEventListener("wheel", (e)=>{
  e.preventDefault();
  const factor = 1 + Math.sign(e.deltaY)*0.1;
  radius *= factor;
  radius = Math.max(200, Math.min(4000, radius));
  updateCam();
},{passive:false});

/* ---------- ì¬ìƒ/í”Œë˜ì‹œ ---------- */
let isPlaying=false;
let last=performance.now();
let speed=0.35;

// í”Œë˜ì‹œ: ì§§ê³  ë¶€ë“œëŸ½ê²Œ, í™”ë©´ ì „ì²´ëŠ” ì•ˆ í•˜ì–—ê²Œ
let flashT = 0;                 // ë‚¨ì€ ì‹œê°„ (ì´ˆ)
const FLASH_DUR = 0.5;          // í”Œë˜ì‹œ ì „ì²´ ê¸¸ì´

function triggerFlash(strength=1){
  // strength 0~1 ë²”ìœ„ë¡œ í”Œë˜ì‹œ ê°•ë„ ì¡°ì ˆ
  flashT = FLASH_DUR * Math.max(0, Math.min(1,strength));
}

playBtn.onclick=()=>{
  isPlaying=!isPlaying;
  playBtn.textContent=isPlaying?"â¸ Pause":"â–¶ Play";
  last=performance.now();
  if(isPlaying){
    // ì¬ìƒ ì‹œì‘í•  ë•Œë§Œ ì§§ì€ í”Œë˜ì‹œ
    triggerFlash(0.8);
  }
};

/* ---------- ë¼ë²¨ í•˜ì´ë¼ì´íŠ¸ ---------- */
const labels={
  "Inflation":document.getElementById("labInflation"),
  "Plasma Era":document.getElementById("labPlasma"),
  "Recombination":document.getElementById("labRecomb"),
  "Dark Ages":document.getElementById("labDark")
};
function highlightEpoch(ep){
  for(const k in labels) labels[k].classList.remove("active");
  if(labels[ep]) labels[ep].classList.add("active");
}

/* ---------- ë©”ì¸ ë£¨í”„ ---------- */
let prevEpoch = null;

function animate(ts){
  requestAnimationFrame(animate);
  const dt_ms = (ts - last);  // ms

  // ìë™ ì¬ìƒ: Cosmic Time ìŠ¬ë¼ì´ë” ì¦ê°€
  if(isPlaying && dt_ms>30){
    let v=parseFloat(elTime.value) + speed;
    if(v>100) v=100;
    elTime.value=v;
    last=ts;
  }

  const t = parseFloat(elTime.value)/100;
  const a = a_phys(t,70,0.3,0.7);
  const T = T_from_a(a);
  const rho = rho_from_a(a);
  const ep = epochOf_t(t);  // t ê¸°ë°˜ìœ¼ë¡œ Epoch ê²°ì •

  // Epoch ë°”ë€” ë•Œë§ˆë‹¤ ì•½í•œ í”Œë˜ì‹œ í•œ ë²ˆ
  if (prevEpoch !== null && prevEpoch !== ep){
    triggerFlash(0.6);
  }
  prevEpoch = ep;

  highlightEpoch(ep);

  // Epochë³„ ê¸°ë³¸ ìƒ‰/í¬ê¸°
  const baseColor = new THREE.Color(STAR_CLR[ep] || 0xffffff);
  let baseSize =
    (ep === "Inflation")    ? 3.0 :
    (ep === "Plasma Era")   ? 3.2 :
    (ep === "Recombination")? 3.4 :
                               3.2;

  // í”Œë˜ì‹œ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ (ì´ˆ ë‹¨ìœ„)
  if (flashT > 0){
    flashT = Math.max(0, flashT - dt_ms/1000);
  }

  // í”Œë˜ì‹œ íš¨ê³¼ ì ìš©: size + color ì•½ê°„ë§Œ ë°ê²Œ, ë°°ê²½ì€ ê·¸ëŒ€ë¡œ
  if (flashT > 0){
    const k = flashT / FLASH_DUR;     // 0~1
    const extraSize = 4 * k;          // ìµœëŒ€ 4í”½ì…€ ì •ë„ë§Œ ì¶”ê°€
    const flashColor = baseColor.clone();
    // í°ìƒ‰ ìª½ìœ¼ë¡œ ì‚´ì§ë§Œ ì¹˜ìš°ì¹˜ê²Œ (0.5*k)
    flashColor.lerp(new THREE.Color(0xffffff), 0.5 * k);
    mat.size = baseSize + extraSize;
    mat.color.copy(flashColor);
  } else {
    mat.size = baseSize;
    mat.color.copy(baseColor);
  }

  // ë°°ê²½ìƒ‰
  renderer.setClearColor(BG_CLR[ep] || "#000010");

  // Dark Agesì—ì„œë§Œ ì•ˆê°œ ì¶”ê°€
  if(ep==="Dark Ages"){
    scene.fog = new THREE.FogExp2(0x150030,0.0012);
  } else {
    scene.fog = null;
  }

  // ìš°ì£¼ íŒ½ì°½ ìŠ¤ì¼€ì¼ + ì•½ê°„ì˜ íšŒì „
  stars.scale.setScalar(1 + t*5);
  stars.rotation.y += 0.0015;

  // ì²œì²œíˆ ì¹´ë©”ë¼ ë°©ìœ„ê° íšŒì „ (ê¸°ë³¸)
  theta += 0.0003;
  updateCam();

  // HUD ì—…ë°ì´íŠ¸
  badge.textContent = ep;
  epochEl.textContent = `Epoch: ${ep}`;
  statsEl.textContent = `a=${a.toFixed(4)} | T=${T.toExponential(3)} K | Ï=${rho.toExponential(3)}`;

  // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ (ê·¸ë˜í”„ ìˆ¨ê²¨ì ¸ ìˆì–´ë„ ë°ì´í„°ëŠ” ê³„ì† ëˆ„ì )
  chart.data.labels.push(t.toFixed(2));
  chart.data.datasets[0].data.push(a);
  chart.data.datasets[1].data.push(T*1000);
  chart.data.datasets[2].data.push(rho);
  if(chart.data.labels.length>150){
    chart.data.labels.shift();
    chart.data.datasets.forEach(d=>d.data.shift());
  }
  chart.update();

  renderer.render(scene,camera);
}
animate();

/* ---------- ë¦¬ì‚¬ì´ì¦ˆ ---------- */
addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
  updateCam();
});
</script>
</body>
</html>
